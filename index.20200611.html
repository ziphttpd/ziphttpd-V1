<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>ZipHttpd ガイド - トップ</title>
		<link rel="stylesheet" type="text/css" href="css/common.css">
		<link rel="stylesheet" type="text/css" href="highlight/a11y-dark.css">
		<script src="highlight/highlight.pack.js"></script>
		<script>hljs.initHighlightingOnLoad();</script>
		<script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
<script type="text/javascript">
function googleTranslateElementInit() {
  new google.translate.TranslateElement({pageLanguage: 'ja', layout: google.translate.TranslateElement.InlineLayout.SIMPLE}, 'google_translate_element');
}
</script>
	</head>
	<body>
<div id="side">
	<div class="title">
		<img class="minilogo" src="img/ZipHttpd.svg"/>
		&nbsp;ZipHttpd<br>
		&nbsp;ガイドブック<br>
	</div>
	<div class="version">ver 0.01&nbsp;(2020/05)</div>
	<hr class="isohr"/>
	<div class="toc">
		目次<br>
		<div class="toc_h2">
			<a href="index.html">概要</a><br>
		</div>
		<div class="toc_h3">
			<a href="#httpd">HTTP サーバの優れた点</a><br>
			<a href="#ZipHttpd">ZipHttpd の優れた点</a><br>
			<a href="#other">ライセンスなど</a><br>
		</div>
		<div class="toc_h2">
			<a href="#use">利用ガイド</a><br>
		</div>
		<div class="toc_h3">
			<a href="#use_run">使用方法</a><br>
			<a href="#develop_directory">ディレクトリ構成</a><br>
			<a href="#develop_files">ファイル構成</a><br>
		</div>

		<div class="toc_h2">
			<a href="#document">ドキュメントモデル</a><br>
		</div>
		<div class="toc_h3">
			<a href="#ドキュメント">ドキュメント</a><br>
			<a href="#ドキュメントグループ">ドキュメントグループ</a><br>
		</div>
		<div class="toc_h2">
			<a href="#develop">ドキュメント開発ガイド</a><br>
		</div>
		<div class="toc_h3">
		</div>
		<div class="toc_h2">
			<a href="#WebAPI">WebAPI</a><br>
		</div>
		<div class="toc_h3">
			<a href="#機能">機能</a><br>
			<a href="#session">セッション管理</a><br>
		</div>
	</div>
	<hr class="isohr"/>
	<div id="google_translate_element"></div>

</div>
<div id="main">
		<h1>はじめに</h1>

			<p class="ind1em">
				ZipHttpd はローカルで動かす WEB サーバです。<br>
				HTML や画像などのコンテンツを zip に圧縮したファイルを用います。<br>
				なお、自動で解凍されますので利用者は意識する必要はありません。<br>
			</p>

			<p class="append">
				コンテンツを圧縮したファイルの規定の拡張子は zhd とします。<br>
				zhd は単に zip ファイルの拡張子を変更したものです。<br>
				なので、実質的に同じものである zhd, zip, jar は全て利用可能です。<br>
				以降では、より一般的である zip で記述を統一します。<br>
			</p>
			<p class="append">
				また、以降では画像などの構成要素をコンテンツとし、全体をドキュメントと呼ぶこととします。<br>
			</p>

			<p class="ind1em">
				ZipHttpd では JavaScript で任意のテキストを保存するための WebAPI を実装しています。<br>
				コンテンツからは数十MBを超えるようなデータでも保存できます。<br>
			</p>

			<p class="append">
				このテキストは ZipHttpd の管理下に置かれるため、ブラウザや OS 間で持ち運ぶことが可能です。<br>
			</p>

			<p class="ind1em">
				ZipHttpd は多数の OS で利用可能な <a target="new" href="https://golang.org/">Go 言語</a>で記述しています。<br>
				そのため利用できる OS は、Windows/Linux/iOS など多岐にわたります。<br>
				将来的には iPhone/Android などのモバイル端末も含めた利用を想定しています。<br>
			</p>

		<h1>概要</h1>
		<a name="httpd"></a>
		<h2>HTTP サーバの優れた点</h2>

			<p class="ind1em">
				ドキュメントの提供において、事実上の標準として PDF があります。<br>
				しかし PDF はあくまで印刷を目的としたフォーマットです。<br>
				印刷を目的としないドキュメントにおいては HTML が主流です。<br>
			</p>
			<p class="append">
				例：技術系の文書 <a target="new" href="https://developer.mozilla.org/ja/">MDN web docs</a>, <a target="new" href="https://docs.microsoft.com/ja-jp/">Microsoft Docs</a><br>
			</p>
			<p class="ind1em">
				HTTP サーバの優れた点についてご説明させていただきます。<br>
			</p>

			<div class="ind30px">
				<h3>表現力の高さ</h3>
				<div class="ind1em">
					１．見やすい情報提供が容易<br>
					<p class="append">
						ハイパーテキストであるため、高度な構造化が可能で、見やすい情報提供が容易です。<br>
					</p>
					２．動画などのマルチメディアの使用が容易<br>
					<p class="append">
						インタラクティブな操作の提供、動画などのマルチメディアの使用が容易です。<br>
					</p>
					３．SNS や自社サイトとの連携が容易<br>
					<p class="append">
						インターネットとの親和性が高く、Twitter などの SNS や自社サイトとの連携ができます。<br>
					</p>
					４．段階的な導入が可能<br>
					<p class="append">
						表現力の向上は可能ではありますが、それは必要であるという意味ではありません。<br>
						HTML を使うことは、伸びしろを持たせることが可能になるということです。<br>
					</p>
				</div>

				<h3>採用する障壁の低さ</h3>
				<div class="ind1em">
					１．新たな調査・開発・購入コストが不要<br>
					<p class="append">
						自社サイトなどの開発で培われた WEB 制作技術や資産をそのまま応用できます。<br>
						そのため、新たな調査・開発・購入コストは不要です。<br>
					</p>
					２．コストの見積もりが容易<br>
					<p class="append">
						自社サイトを外注されているという場合でも、その発注先などにそのまま発注できます。<br>
						発注実績がありますので、コストの見積もりが容易です。<br>
					</p>
					３．自社のサーバ能力の増強が不要<br>
					<p class="append">
						表示させるコンテンツは利用者のマシンで稼働されます。<br>
						そのため、自社のサーバ能力を増強する必要がありません。<br>
					</p>
				</div>

				<h3>セキュリティ向上</h3>
				<div class="ind1em">
					１．脆弱性の発生する余地が少ない<br>
					<p class="append">
						HTTP サーバはコンテンツを解釈・実行しませんので機能が単純です。<br>
						オープンソースとして公開することで、第三者のチェックにより、安全性を二重に担保します。<br>
						したがって、脆弱性の発生する余地は少なく、発生時には迅速に対応可能であると言えます。<br>
					</p>
					２．ブラウザの脆弱性に対して代替手段が豊富<br>
					<p class="append">
						ビュアーであるブラウザは選択肢が多いため、別のブラウザを使えば安全です。<br>
					</p>
				</div>

			</div>


		<a name="ZipHttpd"></a>
		<h2>ZipHttpd の優れた点</h2>

			<p class="ind1em">
				ZipHttpd の優れた点についてご説明させていただきます。<br>
			</p>

			<div class="ind30px">
				<h3>低コスト</h3>
				<p class="ind1em">
					導入費用も機能制限も存在しません。<br>
					<a href="static">ドキュメントを開発するための機能</a>を標準で装備しています。<br>
				</p>

				<h3>手軽さ</h3>
				<p class="ind1em">
					レジストリや /etc などを使用しません。<br>
					したがってインストールする必要がありません。<br>
					USBメモリなどポータブルなストレージに入れておくだけでも使用できます。<br>
				</p>
				<p class="ind1em">
					１．<span class="strong">ダウンロードした zip ファイルを、<a href="#develop_directory">ドキュメントのディレクトリ</a>にコピーする。</span><br>
					２．<span class="strong">ZipHttpd を起動（再起動）する。</span><br>
				</p>
				<p class="ind1em">
					この２ステップで、解凍などの手間をかけずに、ブラウザから参照できるようになります。<br>
				</p>
				<p class="ind1em">
					ドキュメント内に<a href="#config.json">マニフェストファイル</a>が同梱されていれば調整せずに使用できます。<br>
					手作業で調整するには、<a href="#zhd.json">ドキュメント単位の設定ファイル</a>を手直しします。<br>
				</p>
				<p class="append">
					調整とは、初期表示するページの指定などのドキュメント固有の挙動を定義することです。<br>
				</p>

				<h3>WebAPI</h3>
				<p class="ind1em">
					ビルトインな <a href="#WebAPI">WebAPI</a> を実装しています。<br>
				</p>
				<p class="ind1em">
					ストレージ API や IndexedDB API では<br>
					・ 保存したデータをバックアップするのが困難である。<br>
					・ 異なるブラウザ、Windows/Linux など異なるプラットフォームで共有される保証はない。<br>
					・ ブラウザの都合で消去されることがある。<br>
					といった制限があります。<br>
				</p>
				<p class="ind1em">
					特にデータが消去されるのは最悪で、そのため限定的な利用に留まらざるを得ません。<br>
					しかし WebAPI ならば、データは利用者が管理することができます。<br>
				</p>
				<p class="append">
					もちろん、IndexedDB API などを利用することを妨げるわけではありません。<br>
					ドキュメントの開発者は採用するかどうか選択できます。<br>
				</p>

				<h3>可搬性</h3>
				<p class="ind1em">
					<a target="new" href="https://golang.org/">Go 言語</a>で記述していますので、Windows/Linux などプラットフォームを問いません。<br>
					ポータブルなストレージにそれぞれの実行ファイルを入れておけば、持ち運んでの利用が可能です。<br>
				</p>
				<p class="append">
					当面は利用者の絶対数から Windows での利用のみを想定しています。<br>
					開発リソース上の問題で Windows 以外のプラットフォームでの公式なサポートまでは残念ながら手が回りません。<br>
					なお常駐させた場合の終了方法ですが、SIGINT か SIGKILL を送ればスマートに終了します。<br>
				</p>

				<p class="ind1em">
					単一実行ファイルであり、別途インストールしなければならないファイルは基本的にはありません。<br>
				</p>
				<p class="append">
					Windows では常駐や再起動させる方法に不便があります。<br>
					必須ではありませんが、タスクトレイで常駐させるためのサポートツールをご用意してあります。<br>
				</p>
			</div>

		<a name="other"></a>
		<h2>ライセンスなど</h2>
		<div class="ind30px">

			<h3>条項</h3>
			<p class="ind1em">
				１．本ソフトウェアは無保証です。<br>
				<p class="append">
					ziphttpd.com は、契約行為、不法行為、またはそれ以外であろうと、ソフトウェアに起因または関連し、あるいはソフトウェアの使用またはその他の扱いによって生じる一切の請求、損害、その他の義務について何らの責任も負わないものとします。<br>
				</p>
			</p>

			<p class="ind1em">
				２．再配布権は ziphttpd.com が保持します。<br>
				<p class="append">
					フォークやクローンなどによるリポジトリや自家製ビルドされたバイナリの再配布は公式としては許可しません。<br>
				</p>
			</p>

			<h3>広告機能</h3>
			<p class="ind1em">
				ZipHttpd はご利用においての課金等は行いませんが、無償で提供する商用アプリです。<br>
				開発資金は、広告やスポンサー契約によって賄います。<br>
				著作権問題を回避するため、ドキュメントの表示において<span style="color: red;">コンテンツの改変は行いません</span>。<br>
				広告は Ziphttpd 固有のページにおいてのみ表示します。<br>
				現在は以下のサンプル画像にある赤枠の部分が広告領域です。<br>
			</p>
			<p class="ind10">
				<img src="img/sample-login.png" title="サンプル画面"></img><br>
			</p>

			<p class="ind1em">
				<span style="color: red;"><b>広告機能に対するパッチの公開など</b>はご遠慮ください。</span><br>
			</p>

			<h3>機能的な問題に対する申し立て</h3>
			<p class="ind1em">
				機能的に問題がある場合には、GitHub の issue、pullリクエスト、<br>
				ないしは<a target="new" href="https://www.ipa.go.jp/security/vuln/report/">脆弱性関連情報の届出受付</a>でのご連絡をお願いいたします。<br>
			</p>

			<h3>スポンサード</h3>
			<p class="ind1em">
				ZipHttpd.com はスポンサーを募集する予定です。<br>
				スポンサーとして契約していただいている団体には、以下の特典をご提供いたします。<br>
				・ 広告領域への広告出稿。<br>
				・ 機能拡張要望の優先検討。<br>
				・ インシデント発生時の対応情報の優先提供。<br>
				・ ソースコードの独自ポーティングと公開の権利。（要ご相談）<br>
			</p>

		</div>

		<a name="use"></a><br>
		<h2>利用ガイド</h2>
		<div class="ind30px">

			<a name="use_run"></a><br>
			<h3>使用方法</h3>

			<div class="ind30px">

				<h4>準備</h4>
				<p class="ind1em">
					任意のディレクトリにファイルを置きます。<br>
				</p>

<div class="half">実行前のファイル構成<pre><code class="text">D:\.ziphttpd>tree . /F
D:\.ZIPHTTPD
│  ziphttpd.exe
│  launcher.exe
│
└─docs
        prototype.zip
</code></pre></div>

				<p class="append">
					launchar.exe は Windows のサポートアプリ(.Net)です。<br>
					prototype.zip はドキュメント開発で使用するひな型です。<br>
					どちらも必須ではありません。<br>
				</p>

				<h4>実行</h4>
				<p class="ind1em">
					ziphttpd.exe を実行します。<br>
					quit とコマンドを入力すると終了します。<br>
				</p>

<div class="half">実行例<pre><code class="text">D:\.ziphttpd>ziphttpd
directory : D:\.ziphttpd
quit

D:\.ziphttpd>
</code></pre></div>

				<p class="ind1em">
					実行により以下のようなファイル構成が生成されます。<br>
				</p>

<div class="half">実行後のファイル構成<pre><code class="text">D:\.ziphttpd>tree . /F
D:\.ZIPHTTPD
│  ziphttpd.exe
│  launcher.exe
│  ziphttpd.json
│  portlockins.json
│
├─docs
│      prototype.zip
│      prototype.json
│
├─log
│      ziphttpd.log
│
├─static
│  └─prototype.com
│      └─prototype
├─api
│  └─prototype.com
└─system
</code></pre></div>

				<h4>コマンドライン</h4>
				<p class="ind1em">
					-h をつけて実行するとコマンドライン引数の説明が表示されます。<br>
				</p>


<div class="half">コマンドラインヘルプ<pre><code class="text">D:\.ziphttpd> ziphttpd -h
Usage of ziphttpd:
  -config string
        configuration directory
  -docport int
        document listen port (default 58823)
  -log string
        logging directory
  -port int
        listen port (default 8823)
</code></pre></div>

				<p class="ind1em">
				</p>

			</div>


			<a name="develop_directory"></a><br>
			<h3>ディレクトリ構成</h3>

			<div class="ind30px">

				<h4>基準ディレクトリ</h4>
				<p class="ind1em">
					基本的には ZipHttpd の実行ファイルがあるディレクトリを使用します。<br>
					実行時引数で特定ディレクトリを指定できます。<br>
				</p>

				<p class="ind1em">
					まずは、ZipHttpd 設定ファイル (<a href="#ziphttpd.json">後述</a>) の置き場として考えてください。<br>
				</p>

				<h4>ドキュメントディレクトリ (docs)</h4>
				<p class="ind1em">
					zip ファイルをコピーするディレクトリです。<br>
				</p>
				<p class="ind1em">
					実行例で見られるように、ZipHttpd を起動すると zip ファイルに対応した json ファイルが生成されます。<br>
					これはドキュメント単位の設定ファイルです。<br>
				</p>

				<h4>ログディレクトリ (log)</h4>
				<p class="ind1em">
					実行時ログ ziphttpd.log を出力するディレクトリです。<br>
					基準ディレクトリの下の log を使用しますが、実行時引数 -log で特定ディレクトリを指定できます。<br>
					/var/log 以下にログを出力させたい場合に指定します。<br>
				</p>
<div class="half">ログ<pre><code class="text">2020/05/26 03:18:07 C:/xorvercom/ziphttpd/cmd/main.go:50: [INFO] ---- server start ----
2020/05/26 03:18:07 C:/xorvercom/ziphttpd/cmd/internal/httpd/server.go:35: [INFO] create server:prototype.com
2020/05/26 03:18:07 C:/xorvercom/ziphttpd/cmd/internal/httpd/server.go:48: [INFO] run server:prototype.com, port:58823
2020/05/26 03:18:07 C:/xorvercom/ziphttpd/cmd/internal/httpd/server.go:35: [INFO] create server:system
2020/05/26 03:18:07 C:/xorvercom/ziphttpd/cmd/internal/httpd/server.go:48: [INFO] run server:system, port:8823
2020/05/26 03:18:10 C:/xorvercom/ziphttpd/cmd/main.go:96: [INFO] ---- server stop ----
2020/05/26 03:18:10 C:/xorvercom/ziphttpd/cmd/main.go:73: [INFO] signal: interrupt
2020/05/26 03:18:10 C:/xorvercom/ziphttpd/cmd/internal/httpd/server.go:65: [WARN] server:system : accept tcp [::]:8823: use of closed network connection
2020/05/26 03:18:10 C:/xorvercom/ziphttpd/cmd/internal/httpd/server.go:65: [WARN] server:prototype.com : accept tcp [::]:58823: use of closed network connection
</code></pre></div>

				<p class="ind1em">
					ローテーションなどは行いませんので、定期的に削除してください。<br>
				</p>
				<p class="ind1em">
				</p>

				<h4>一般 API データディレクトリ (api)</h4>
				<p class="ind1em">
					WebAPI での登録データを格納するディレクトリです。<br>
					api/ドキュメントグループ名/ に格納します。<br>
				</p>

				<h4>システム API データディレクトリ (system)</h4>
				<p class="ind1em">
					system ドキュメントグループが WebAPI で使用する予定です。<br>
					system ドキュメントグループではドキュメントに対する API も使用できるようにする想定ですので特殊です。<br>
					そのため念のために隔離しているだけで、現時点では使用されません。<br>
				</p>

				<a name="static"></a>
				<h4>静的ファイルディレクトリ (static)</h4>
				<p class="ind1em">
					ドキュメント開発作業用のフォルダです。<br>
					static/ドキュメントグループ名/ドキュメント名/以下を読み出します。<br>
					<span class="strong">使用にはドキュメントの設定ファイルで usestaticfiles を宣言する必要があります。</span><a href="#ドキュメント設定ファイル">→ 参照</a><br>
					利用すると、zip ファイル内のファイルよりも優先的に読み出します。<br>
					ドキュメントのディレクトリの外は参照できません。<br>
				</p>

			</div>

			<a name="develop_files"></a><br>
			<h3>ファイル構成</h3>

			<p class="ind30px">
				ZipHttpd において、設定ファイルは　json として記述します。<br>
			</p>

			<div class="ind30px">

				<a name="ziphttpd.json">
				<h4>ZipHttpd 設定ファイル</h4>
				<p class="ind1em">
					ziphttpd.json という固定の名称のファイルです。<br>
				</p>

<div class="half">ziphttpd.json の例<pre><code class="json">{
    "contenttype": {
        "html,htm": "text/html",
        "js": "text/javascript",
        "json": "text/json",
        "css": "text/css",
        "txt": "text/plain",
        "md": "text/markdown",
        "bmp": "image/bmp",
        "gif": "image/gif",
        "ico": "image/ico",
        "jpg,jpg,jpeg,jfif,pjpeg,pjp": "image/jpeg",
        "png": "image/png",
        "svg": "image/svg+xml",
        "endterminator": null
    },
    "endterminator": null
}
</code></pre></div>

				<a name="zhd">
				<h4>ドキュメントファイル</h4>
				<p class="ind1em">
					ドキュメントディレクトリに入れる zip ファイルです。<br>
				</p>

				<a name="zhd.json">
				<h4>ドキュメント設定ファイル</h4>
				<p class="ind1em">
					ドキュメントファイルの拡張子を json に置き換えたファイルです。<br>
					マニフェストファイルがない場合にはpathとnameだけが設定されます。<br>
				</p>

<div class="half">ドキュメント設定ファイルの例<pre><code class="json">{
    "name": "任意の名称",
    "path": "ファイル.zip",
}
</code></pre></div>

				<p class="ind1em">
					<table class="std">
						<tr><th>キー</th><th>デフォルト</th><th>機能</th><th>その他</th></tr>
						<tr><td>path</td><td>zip ファイル名</td><td>zip ファイル名</td><td>絶対パスで記述可能。</td></tr>
						<tr><td>docgroup</td><td>"common"</td><td>ドキュメントグループ名</td><td rowspan="2">トップページに表示されます。<br>またURLパスの先頭に使用されます。</td></tr>
						<tr><td>name</td><td>zip ベース名</td><td>ドキュメント名<br></td></tr>
						<tr><td>contentencoding</td><td>"utf-8"</td><td>Content-Encoding</td><td>テキストの文字エンコーディングです。</td></tr>
						<tr><td>contenttype</td><td>なし</td><td>Content-Type</td><td>拡張子別の MIME タイプを記述します。<br>指定しない場合、ZipHttpd 設定ファイルを参照します。</td></tr>
						<tr><td>host</td><td>なし</td><td>配布元のホスト名</td><td>将来的に署名や更新で使用します。<a href="#ドキュメントグループ署名">→ 参照</a></td></tr>
						<tr><td>usestaticfiles</td><td>false</td><td>開発用フラグ</td><td><a href="#静的ファイルディレクトリ">静的ファイルディレクトリ</a>を使用します。</td></tr>
					</table>
				</p>
				<p class="append">
					同じドキュメントグループ名で同じドキュメント名を持つドキュメントが存在した場合、動作は不定です。<br>
				</p>

				<a name="config.json">
				<h4>マニフェストファイル</h4>
				<p class="ind1em">
					ドキュメントファイル内に入れておく ziphttpd/config.json という固定の名称のファイルです。<br>
				</p>

<div class="half">docs/prototype.zip/ziphttpd/config.json<pre><code class="json">{
    "name": "prototype",
    "docgroup": "prototype.com",
    "host": "prototype.com",
    "contentencoding": "utf-8",
    "docroot": "index.html",
    "contenttype": {
        "html,htm": "text/html",
        "js": "text/javascript",
        "css": "text/css",
        "png": "image/png",
        "ico": "image/icon",
        "svg": "image/svg+xml"
    },
    "usestaticfiles": true
}
</code></pre></div>

				<p class="ind1em">
					参考例に対応したドキュメントの設定ファイルは以下のように自動設定されます。<br>
				</p>

<div class="half">docs/prototype.json<pre><code class="json">{
    "contentencoding": "utf-8",
    "contenttype": {
        "css": "text/css",
        "html,htm": "text/html",
        "ico": "image/icon",
        "js": "text/javascript",
        "png": "image/png",
        "svg": "image/svg+xml"
    },
    "docgroup": "prototype.com",
    "docroot": "index.html",
    "host": "prototype.com",
    "name": "prototype",
    "path": "prototype.zip",
    "usestaticfiles": true
}
</code></pre></div>

		</div>

		<a name="document"><br>
		<h2>ドキュメントモデル</h2>
		<div class="ind30px">

			<a name="ドキュメント">
			<h3>ドキュメント</h3>
			<p class="ind1em">
				一つの zip ファイルです。<br>
				規定の拡張子は zhd ですが、zip, jar も利用できます。<br>
				つまり、一般的に流通している JavaDoc を表示する目的で使用できます。<br>
			</p>
			<p class="append">
				文字コードと、初期表示ページを<a href="#zhd.json">設定ファイル</a>で指定することでより便利に使えます。<br>
			</p>

			<a name="ドキュメントグループ">
			<h3>ドキュメントグループ</h3>
			<p class="ind1em">
				複数のドキュメントをグループ化したものです。<br>
				<a href="#zhd.json">ドキュメント設定ファイル</a>で設定されますが、将来的には署名機能と連携します。<br>
				WebAPI ではドキュメントグループが一つのサーバとして稼働するため、セキュリティを保証するためです。<br>
			</p>

			<h4>(将来機能) ドキュメントグループ署名</h4>
			<p class="ind1em">
				設定ファイルの host 設定から SSL を使用して公開鍵と署名のファイルを取得します。<br>
				そして、署名が無いドキュメントがドキュメントグループにある場合は警告します。<br>
				SSL によりドキュメントの配布元の公開鍵と署名の正当性を担保するというコンセプトです。<br>
			</p>
			<p class="append">
				DNS キャッシュポイズニングによるサイト偽装が脅威ですが、攻撃コスト的に見合わないだろうとの判断です。<br>
				ドキュメント配布元を狙うよりも銀行サイトなど優先度の高い攻撃目標がいくらでもあります。<br>
			</p>
			<p class="ind1em">
				以上の理由より<a href="#zhd.json">host設定</a>には、作成者が管理している WEB サーバを指定しておいてください。<br>
				署名ツールなどは、MIT ライセンスで提供予定です。<br>
			</p>

		</div>

		<a name="develop"></a><br>
		<h2>ドキュメント開発ガイド</h2>

		<div class="ind30px">
			１．prototype.zip を任意の名前でドキュメントディレクトリにコピーします。<br>
			２．ZipHttpd を起動すると、static/prototype.com/任意の名前としてディレクトリが作成されます。<br>
			３．２で作成されたディレクトリ以下に html などコンテンツを作成します。<br>
			４．ブラウザで prototype.com ドキュメントグループ以下にアクセスすると３で配置したコンテンツはドキュメントとして稼働します。<br>
			５．２で作成されたディレクトリ以下を zip 圧縮すれば、配布できるドキュメントが完成です。<br>
		</div>

		<a name="WebAPI"><br>
		<h2>WebAPI</h2>

		<div class="ind30px">

			<div class="ind1em">
				WebAPI は ZipHttpd にリクエストすることで JavaScript では実現できない効果を得るものです。<br>
			</div>

			<a name="機能"><br>
			<h3>機能</h3>
			<p class="ind1em">
				API-Ver.1 では、キーに対して値を記録する機能が実装されています。<br>
				API-Ver.2 では、ブラウザからの接続を保持して、値の変更などの契機でプッシュ通知を行う予定です。<br>
			</p>
			<p class="append">
				WebAPI を呼びだすリファレンス実装として <a target="new" href="js/zhapi.js">zhapi.js</a> を用意してあります。<br>
				WebAPI を呼びだすサンプルとして <a target="new" href="js/apitest.js">apitest.js</a> を用意してあります。<br>
			</p>

			<div class="ind1em">

				<h4>(採用予定なし) ネットワーククライアント機能</h4>
				<p class="ind1em">
					なお、ネットワーククライアント機能は ZipHttpd に実装する予定はありません。<br>
					理由は、それが脆弱性の温床となる可能性を危惧しているためです。<br>
				</p>
				<p class="append">
					例外として開発中の機能として、ドキュメントの署名検証機能があります。<br>
					これは別のアプリとして実装し、ZipHttpd はダウンロード結果を利用する予定です。<br>
					<br>
					ドキュメントに記述されたサイトに公開されている公開鍵を SSL により取得します。<br>
					公開鍵の正当性を、SSL をもって担保とするコンセプトで、利用のためにドメインの取得は必須です。<br>
					ドメインの維持費以外は GCP 無料枠などを使うことでコストはかかりません。<br>
				</p>

			</div>

			<a name="session"><br>
			<h3>セッション管理</h3>
				<p class="ind1em">
					<a target="new" href="js/zhapi.js">zhapi.js</a> で実装されていますので、とりあえず気にする必要はありません。<br>
					この項は、セキュリティ保持のメカニズムをレビューする場合のガイドです。<br>
				</p>

			<div class="ind1em">

				<h4>概要</h4>
				<p class="ind1em">
					WebAPI ではセンシティブな情報も保存できるように設計しています。<br>
					そのためには、他のドキュメントグループからの WebAPI 実行を防止する仕掛けを持ちます。<br>
					一般的な CSRF 対策とは少し事情が異なりますのでご注意ください。<br>
				</p>

				<h4>基本的事項</h4>
				<p class="ind1em">
					ドキュメントグループごとに別個のポートを使用し別<a target="new" href="https://developer.mozilla.org/ja/docs/Web/Security/Same-origin_policy#Definition_of_an_origin">オリジン</a>として、API を隔離しています。<br>
					ちなみに、別オリジンに属するページからの WebAPI の実行は、無条件で失敗します。<br>
				</p>
				<p class="append">
					これはプリフライト（厳密には POST 以外の全て）に対して単純にエラーを返しているからです。<br>
					別オリジンからの WebAPI 実行を受け付けるメカニズムに関しては、<a target="new" href="https://developer.mozilla.org/ja/docs/Glossary/CORS">CORS</a> を参照してください。<br>
				</p>

				<p class="ind1em">
					<a target="new" href="js/zhapi.js">zhapi.js</a> を改造する際には、セッション管理が以下のコンセプトで動いている事に注意してください。<br>
					WebAPI は、<br>
					・ 同じオリジンから<br>
					・ X-Requested-With ヘッダに正しい CSRF トークンが設定されている<br>
					リクエストのみが実行可能です。<br>
					CSRF トークンは、ログインページでストレージAPIの token 値として取得します。<br>
					なおトークンは永続的ではなく ZipHttpd が再起動されるとリセットされます。<br>
				</p>

				<h4>ログインページ遷移</h4>
				<p class="ind1em">
					<a target="new" href="js/zhapi.js">zhapi.js</a> を読み込むと、トークンが取得されていない場合には、ログインページに自動遷移します。<br>
				</p>

<div class="half">チェック部分 (<a target="new" href="js/zhapi.js">zhapi.js</a>)<pre><code class="js">(function() {
    const zh = new ZHAPI('auto');
    zh.Noop().then(function(info) {}).catch(function(error) {});
})();
</code></pre></div>

				<h4>ログインページ</h4>
				<p class="ind1em">
					ログインページは、ドキュメントグループに割り当てられたポートの /login です。<br>
					ログインページではパスワードを入力します。<br>
				</p>
				<p class="ind2em">
					<img src="img/sample-login.png" title="サンプル画面"></img><br>
				</p>

				<p class="ind1em">
					ここで入力するパスワードは基準フォルダに password.json として手作業で用意しておきます。<br>
					パスワードを参照できるのならば、攻撃者はファイルを自由に参照できていることになり、その仮定は無意味です。<br>
				</p>

<div class="half">password.json の例<pre><code class="json">{
    "sample": {"password": "pass", "localstorage": true},
    "xxxx": {"password": "pass"}
}
</code></pre></div>

				<p class="ind1em">
					ログイン試行の対策として、一度に一個のリクエストのみ、失敗時には5秒間のウェイトを持たせています。<br>
				</p>

				<h4>ログイン結果</h4>
				<p class="ind1em">
					ログインの試行の結果は、一旦ログインページに戻されます。<br>
					ページのデータとしてトークンが設定されていた場合、トークンを記録して元々の URL に自動的に遷移します。<br>
				</p>

<div class="half">/login でのトークン記録処理部分 (loginHandler.go)<pre><code class="js">        document.addEventListener("DOMContentLoaded", function() {
            let token = "{{.Token}}";
            window['localStorage'].removeItem('token')
            window['sessionStorage'].removeItem('token')
            window['{{.Storage}}'].setItem('token', token);
            if (token) {
                location.href = "{{.RedirectTo}}";
            } else {
                document.all.item("ad").src = "{{.AdURL}}";
            }
        });
</code></pre></div>

				<p class="ind1em">
					CSRF トークンの保存には Cookie ではなく<a target="new" href="https://developer.mozilla.org/ja/docs/Web/API/Window/sessionStorage">セッションストレージ</a>を利用します。<br>
					Cookie はポート番号を区別しないため、別オリジンのドキュメントからでも参照できてしまうからです。<br>
					ストレージ API ならばポート番号が異なる別オリジンのドキュメントでは参照できません。<br>
				</p>
				<p class="append">
					この保存場所は設定で<a target="newpage" href="https://developer.mozilla.org/ja/docs/Web/API/Window/localStorage">ローカルストレージ</a>を使用することもできますが、保持期間が永続的であることには留意してください。<br>
					杞憂ではありますが、何らかの方法でオリジンを誤魔化す脆弱性があった場合など、トークンが漏洩する危険性が増します。<br>
					そのため、上記の例でのxxxxグループのように無指定である場合には、セッションストレージを使用します。<br>
				</p>

			</div>
		</div>

		<hr/>
		copyright ZipHttpd.com 2020<br>
</div>
	</body>
</html>
